#                                               -*- Autoconf -*-
# Process this file with autoconf to produce a configure script.

AC_PREREQ([2.65])

m4_define([ProjectName], [rack])
m4_define([PrefixDefault], [/usr/local/]ProjectName)
m4_define([ConfigScript], [rack-config])

AC_INIT([ProjectName],[m4_normalize(m4_include(config/version))],[],[ProjectName])

PROJNAME=ProjectName
AC_SUBST(PROJNAME)

CONFIG_RACK_VERSION_MAJOR=`expr $PACKAGE_VERSION : '\([0-9]*\)'`
CONFIG_RACK_VERSION_MINOR=`expr $PACKAGE_VERSION : '[0-9]*\.\([0-9]*\)'`
CONFIG_RACK_REVISION_LEVEL=`expr $PACKAGE_VERSION : '[0-9]*\.[0-9]*\.\([0-9]*\)'`
test "x$CONFIG_RACK_REVISION_LEVEL" = "x" && CONFIG_RACK_REVISION_LEVEL=0

AC_CONFIG_HEADERS([config/]ProjectName[_config_pre.h])
AC_CONFIG_SRCDIR([scripts/]ConfigScript[.in])
AC_PREFIX_DEFAULT(PrefixDefault)
AC_CONFIG_AUX_DIR([config/autoconf])
AC_CONFIG_MACRO_DIR([config/m4])

AC_CANONICAL_BUILD
AC_CANONICAL_HOST
AC_PROG_INSTALL

CFLAGS=${CFLAGS:--s}

dnl ======================================================================
dnl checking SVN revision
dnl ======================================================================

AC_MSG_CHECKING([for SVN revision])
SVN=`which svn`
if test x$SVN \!= x; then
   PACKAGE_SVN_REVISION=`cd $srcdir; $SVN info 2>/dev/null|grep Revision|cut -d' ' -f2`
   if test x$PACKAGE_SVN_REVISION \!= x; then
       AC_DEFINE_UNQUOTED(PACKAGE_SVN_REVISION, "${PACKAGE_SVN_REVISION}", [SVN revision])
   fi
fi
AC_MSG_RESULT([${PACKAGE_SVN_REVISION:-(release)}])

dnl ======================================================================
dnl checking cc
dnl ======================================================================

AC_ARG_WITH(CC,
    AS_HELP_STRING([--with-cc=compiler], [use specific C compiler]),
    [case "$withval" in
    "" | y | ye | yes | n | no)
  AC_MSG_ERROR([*** You must supply an argument to --with-cc.]) ;;
    esac
    CC="$withval"])
AC_PROG_CC
AC_PROG_CXX

AC_DEFINE_UNQUOTED(CONFIG_RACK_BUILD_STRING, "$build", [Build system alias])
RACK_BUILD_STRING="$build"
AC_DEFINE_UNQUOTED(CONFIG_RACK_HOST_STRING, "$host", [Host system alias])
RACK_HOST_STRING="$host"
AC_DEFINE_UNQUOTED(CONFIG_RACK_COMPILER, "`$CC -v 2>&1 | tail -n 1`" , [Compiler])

AM_INIT_AUTOMAKE([foreign no-exeext no-dist-gzip dist-bzip2])
AM_MAINTAINER_MODE
LT_INIT
AM_PROG_AS
AC_SUBST(LD)

AC_PATH_PROG(JAR, jar,)
AC_SUBST(JAR)

AC_C_INLINE
AC_HEADER_STDC

dnl ======================================================================
dnl  checking target arch
dnl ======================================================================

AC_MSG_CHECKING([for target architecture])
case "$host" in
  *86*-*)
    RACK_TARGET_ARCH=i386
    wanted_kernel_arch=CONFIG_X86
    ;;
  arm-*)
    RACK_TARGET_ARCH=arm
    wanted_kernel_arch=CONFIG_ARM
    ;;
  powerpc-*|ppc-*)
    RACK_TARGET_ARCH=ppc
    wanted_kernel_arch=CONFIG_PPC
    ;;
  *)
    AC_MSG_ERROR([ *** Sorry - Unsupported architecture])
    ;;
esac
AC_MSG_RESULT([${RACK_TARGET_ARCH}])
AC_SUBST(RACK_TARGET_ARCH)

dnl ======================================================================
dnl  Loading the RACK configuration.
dnl ======================================================================

RACK_KCONFIG_FILE=$srcdir/defconfig
kconfig_type=default

AC_ARG_WITH(kconfig-file,
    AS_HELP_STRING([--with-kconfig-file=<kconfig-file>], [KConfig parameter file]),
    [
        case "$withval" in
        "" | y | ye | yes | n | no)
          AC_MSG_ERROR([You must supply an argument to --with-kconfig-file.])
            ;;
        esac
        RACK_KCONFIG_FILE="$withval"
        kconfig_type=supplied
    ])

AC_MSG_CHECKING([for RACK Kconfig file])
if test \! -f $RACK_KCONFIG_FILE; then
    AC_MSG_ERROR([Kconfig-file $RACK_KCONFIG_FILE not found -- --with-kconfig-file sets Kconfig file])
fi

PATH=$PATH:. . $RACK_KCONFIG_FILE
AC_MSG_RESULT([$RACK_KCONFIG_FILE ($kconfig_type)])

dnl ======================================================================
dnl  LINUX kernel with XENOMAI
dnl ======================================================================

AC_ARG_WITH(linux-dir,
    AS_HELP_STRING([--with-linux-dir=<Linux-Sources>], [Linux source directory]),
    [case "${withval}" in
        y | ye | yes)
            AC_MSG_ERROR([You must supply an argument to --with-linux-dir.])
      ;;
    esac
    CONFIG_RACK_LINUXDIR="$withval"
    ])

if test "${CONFIG_RACK_LINUXDIR}" \!= "" ; then
    dnl -----------------------------------------------------------------
    dnl check config file
    dnl -----------------------------------------------------------------

    AC_MSG_CHECKING([for Linux config file])
    if test \! -f ${CONFIG_RACK_LINUXDIR}/.config ; then
    AC_MSG_ERROR([*** Please configure your kernel])
    fi
    AC_MSG_RESULT([${CONFIG_RACK_LINUXDIR}/.config])

    dnl -----------------------------------------------------------------
    dnl get linux version
    dnl -----------------------------------------------------------------

    AC_MSG_CHECKING([for Linux version])
    LINUX_RELEASE_FILE=${CONFIG_RACK_LINUXDIR}/include/generated/utsrelease.h
    if test \! -f $LINUX_RELEASE_FILE; then
        LINUX_RELEASE_FILE=${CONFIG_RACK_LINUXDIR}/include/linux/utsrelease.h
    fi
    LINUX_VERSION=`grep "#define UTS_RELEASE" $LINUX_RELEASE_FILE 2>/dev/null | sed -e 's/[^\"]*\"\([^\"]*\)\"/\1/'`

    AC_MSG_RESULT([${LINUX_VERSION}])

    dnl -----------------------------------------------------------------
    dnl check version
    dnl -----------------------------------------------------------------

    case "${LINUX_VERSION}" in
        2.6.*)
            ;;
        3.2.*)
            ;;
        *)
            AC_MSG_ERROR([*** Unsupported kernel version $LINUX_VERSION])
            ;;
    esac

    dnl -----------------------------------------------------------------
    dnl loading linux config
    dnl -----------------------------------------------------------------

    . ${CONFIG_RACK_LINUXDIR}/.config

    dnl -----------------------------------------------------------------
    dnl  checking needed Xenomai and skins in linux config
    dnl -----------------------------------------------------------------

    AC_MSG_CHECKING([for Xenomai])
        case "${CONFIG_XENOMAI}" in
            y) AC_MSG_RESULT([${CONFIG_XENOMAI}]) ;;
            *) AC_MSG_ERROR([*** Please enable Xenomai]) ;;
        esac

    AC_MSG_CHECKING([for Xenomai native skin])
        case "${CONFIG_XENO_SKIN_NATIVE}" in
            y | m) AC_MSG_RESULT([${CONFIG_XENO_SKIN_NATIVE}]) ;;
            *) AC_MSG_ERROR([*** Please enable native skin]) ;;
        esac

    AC_MSG_CHECKING([for Xenomai RTDM skin])
        case "${CONFIG_XENO_SKIN_RTDM}" in
            y | m) AC_MSG_RESULT([${CONFIG_XENO_SKIN_RTDM}]) ;;
            *) AC_MSG_ERROR([*** Please enable RTDM skin]) ;;
        esac
fi

AM_CONDITIONAL(CONFIG_RACK_BUILD_KMOD,[test "${CONFIG_RACK_LINUXDIR}" \!= ""])

dnl ======================================================================
dnl  XENOMAI userspace
dnl ======================================================================

AC_ARG_WITH(xeno-user-dir,
    AS_HELP_STRING([--with-xeno-user-dir=<Xenomai>], [Xenomai userspace installation path]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-xeno-user-dir.])
      ;;
    esac
    CONFIG_RACK_XENOMAIDIR="$withval"
    ])

XENO_USER_PREFIX=""
XENO_LIBRARIES=""

if test x"${CONFIG_RACK_OS_XENOMAI}" = x"y"; then
    if test x"$CONFIG_RACK_EXT_XENOMAIDIR" \!= "xy"; then
        CONFIG_RACK_XENOMAIDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/xenomai/usr"
    fi
fi

if test "${CONFIG_RACK_XENOMAIDIR}" \!= "" ; then

dnl -----------------------------------------------------------------
dnl  try to find Xenomai config
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([for Xenomai userspace installation])
XENO_USER_CONFIG="${CONFIG_RACK_XENOMAIDIR}/bin/xeno-config"
if test -x "${XENO_USER_CONFIG}"; then
  XENO_USER_DIR="`cd ${CONFIG_RACK_XENOMAIDIR} && pwd`"
  sed "s+\(^prefix=\)\(..*$\)+\1${XENO_USER_DIR}+" ${XENO_USER_CONFIG} > /tmp/${USER}.xeno_config
  cp /tmp/${USER}.xeno_config ${XENO_USER_CONFIG}
  rm /tmp/${USER}.xeno_config
  AC_MSG_RESULT([${XENO_USER_DIR}])
else
  AC_MSG_ERROR([no Xenomai found in ${CONFIG_RACK_XENOMAIDIR}])
fi

dnl -----------------------------------------------------------------
dnl  get Xenomai user prefix
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([for Xenomai userspace PREFIX])
XENO_USER_PREFIX="`cd \`${XENO_USER_CONFIG} --prefix\` && pwd`"
AC_MSG_RESULT([${XENO_USER_PREFIX}])

dnl -----------------------------------------------------------------
dnl  checking Xenomai version
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([for Xenomai version])
XENO_VERSION_PRE="`${XENO_USER_CONFIG} --version`"

case "$XENO_VERSION_PRE" in
  2.[[3-9]]*)
    XENO_VERSION=xeno-23x
    ;;
  *)
    AC_MSG_ERROR([*** Unsupported Xenomai version $XENO_VERSION_PRE in $XENO_USER_DIR])
  ;;
esac
AC_MSG_RESULT([${XENO_VERSION_PRE}])

dnl -----------------------------------------------------------------
dnl  get some more information about Xenomai
dnl -----------------------------------------------------------------

XENO_LIBRARIES="`${XENO_USER_CONFIG} --library-dir`"

fi

dnl -----------------------------------------------------------------
dnl export xenomai values
dnl -----------------------------------------------------------------

AC_SUBST(XENO_USER_PREFIX)
AC_SUBST(XENO_LIBRARIES)
AC_DEFINE(CONFIG_XENO_23X, 1, [We build for Xenomai 2.3 or newer])

dnl ======================================================================
dnl  check support
dnl ======================================================================

dnl ----- RTnet ---------------------------------------------------------------

AC_ARG_ENABLE(rtnet-support,
    AS_HELP_STRING([--enable-rtnet-support], [enable rtnet support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_RTNET_SUPPORT=y ;;
        *) CONFIG_RACK_RTNET_SUPPORT=n ;;
    esac])

AC_ARG_WITH(rtnet-dir,
    AS_HELP_STRING([--with-rtnet-dir=<rtnet-dir>], [Install directory of RTnet]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-rtnet-dir.])
      ;;
    esac
    CONFIG_RACK_RTNETDIR="$withval"
    ])

dnl ----------------------------------------------------------------------------

AC_ARG_ENABLE(libraw1394-support,
    AS_HELP_STRING([--enable-libraw1394-support], [enable libraw1394 support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LIBRAW1394_SUPPORT=y ;;
        *) CONFIG_RACK_LIBRAW1394_SUPPORT=n ;;
    esac])

AC_ARG_WITH(libraw1394-dir,
    AS_HELP_STRING([--with-libraw1394=<libraw1394-dir>], [Install directory of libraw1394]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-libraw1394.])
      ;;
    esac
    CONFIG_RACK_LIBRAW1394DIR="$withval"
    ])

dnl ----------------------------------------------------------------------------

AC_ARG_ENABLE(libdc1394-support,
    AS_HELP_STRING([--enable-libdc1394-support], [enable libdc1394 support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LIBDC1394_SUPPORT=y ;;
        *) CONFIG_RACK_LIBDC1394_SUPPORT=n ;;
    esac])

AC_ARG_WITH(libdc1394-dir,
    AS_HELP_STRING([--with-libdc1394=<libdc1394-dir>], [Install directory of libdc1394]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-libdc1394.])
      ;;
    esac
    CONFIG_RACK_LIBDC1394DIR="$withval"
    ])

dnl ----------------------------------------------------------------------------

AC_ARG_ENABLE(libjpeg-support,
    AS_HELP_STRING([--enable-libjpeg-support], [enable libjpeg support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LIBJPEG_SUPPORT=y ;;
        *) CONFIG_RACK_LIBJPEG_SUPPORT=n ;;
    esac])

AC_ARG_WITH(libjpeg-dir,
    AS_HELP_STRING([--with-libjpeg=<libjpeg-dir>], [Install directory of libjpeg]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-libjpeg.])
      ;;
    esac
    CONFIG_RACK_LIBJPEGDIR="$withval"
    ])

dnl ----------------------------------------------------------------------------

AC_ARG_ENABLE(libpng-support,
    AS_HELP_STRING([--enable-libpng-support], [enable libpng support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LIBPNG_SUPPORT=y ;;
        *) CONFIG_RACK_LIBPNG_SUPPORT=n ;;
    esac])

AC_ARG_WITH(libpng-dir,
    AS_HELP_STRING([--with-libpng=<libpng-dir>], [Install directory of libpng]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-libpng.])
      ;;
    esac
    CONFIG_RACK_LIBPNGDIR="$withval"
    ])

dnl ----------------------------------------------------------------------------

AC_ARG_ENABLE(opencv-support,
    AS_HELP_STRING([--enable-opencv-support], [enable opencv support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_OPENCV_SUPPORT=y ;;
        *) CONFIG_RACK_OPENCV_SUPPORT=n ;;
    esac])

AC_ARG_WITH(opencv-dir,
    AS_HELP_STRING([--with-opencv=<opencv-dir>], [Install directory of opencv]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-opencv.])
      ;;
    esac
    CONFIG_RACK_OPENCVDIR="$withval"
    ])

dnl ----------------------------------------------------------------------------

AC_ARG_ENABLE(gsl-support,
    AS_HELP_STRING([--enable-gsl-support], [enable gsl support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_GSL_SUPPORT=y ;;
        *) CONFIG_RACK_GSL_SUPPORT=n ;;
    esac])

AC_ARG_WITH(gsl-dir,
    AS_HELP_STRING([--with-gsl=<gsl-dir>], [Install directory of gsl]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-gsl.])
      ;;
    esac
    CONFIG_RACK_GSLDIR="$withval"
    ])

dnl ----------------------------------------------------------------------------

AC_ARG_ENABLE(libusb-support,
    AS_HELP_STRING([--enable-libusb-support], [enable libusb support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LIBUSB_SUPPORT=y ;;
        *) CONFIG_RACK_LIBUSB_SUPPORT=n ;;
    esac])

AC_ARG_WITH(libusb-dir,
    AS_HELP_STRING([--with-libusb=<libusb-dir>], [Install directory of libusb]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-libusb.])
      ;;
    esac
    CONFIG_RACK_LIBUSBDIR="$withval"
    ])

dnl ----------------------------------------------------------------------------

AC_ARG_ENABLE(boost-support,
    AS_HELP_STRING([--enable-boost-support], [enable boost support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_BOOST_SUPPORT=y ;;
        *) CONFIG_RACK_BOOST_SUPPORT=n ;;
    esac])

AC_ARG_WITH(boost-dir,
    AS_HELP_STRING([--with-boost=<boost-dir>], [Install directory of boost]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-boost.])
      ;;
    esac
    CONFIG_RACK_BOOSTDIR="$withval"
    ])

dnl ----------------------------------------------------------------------------

AC_ARG_ENABLE(pcl-support,
    AS_HELP_STRING([--enable-pcl-support], [enable pcl support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_PCL_SUPPORT=y ;;
        *) CONFIG_RACK_PCL_SUPPORT=n ;;
    esac])

AC_ARG_WITH(pcl-dir,
    AS_HELP_STRING([--with-pcl=<pcl-dir>], [Install directory of pcl]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-pcl.])
      ;;
    esac
    CONFIG_RACK_PCLDIR="$withval"
    ])

dnl ----------------------------------------------------------------------------

AC_ARG_ENABLE(openni-support,
    AS_HELP_STRING([--enable-openni-support], [enable openni support]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_OPENNI_SUPPORT=y ;;
        *) CONFIG_RACK_OPENNI_SUPPORT=n ;;
    esac])

AC_ARG_WITH(openni-dir,
    AS_HELP_STRING([--with-openni=<openni-dir>], [Install directory of openni]),
    [case "${withval}" in
        "" | y | ye | yes | n | no)
            AC_MSG_ERROR([You must supply an argument to --with-openni.])
      ;;
    esac
    CONFIG_RACK_OPENNIDIR="$withval"
    ])

dnl ======================================================================
dnl    JAVA Part
dnl ======================================================================

dnl -----------------------------------------------------------------
dnl  rack java
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build java])
AC_ARG_ENABLE(java,
    AS_HELP_STRING([--enable-java], [building java]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_JAVA=y ;;
        *) CONFIG_RACK_JAVA=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_JAVA:-n}])
AM_CONDITIONAL(CONFIG_RACK_JAVA,[test "$CONFIG_RACK_JAVA" = "y"])
if test x"$CONFIG_RACK_JAVA" = "xy"; then
    AC_DEFINE(CONFIG_RACK_JAVA,1,[building java])
fi

AC_SUBST(CONFIG_RACK_JAVA)

dnl -----------------------------------------------------------------
dnl  rack java gui
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build java gui])
AC_ARG_ENABLE(java-gui,
    AS_HELP_STRING([--enable-java-gui], [building java gui]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_JAVA_GUI=y ;;
        *) CONFIG_RACK_JAVA_GUI=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_JAVA_GUI:-n}])
AM_CONDITIONAL(CONFIG_RACK_JAVA_GUI,[test "$CONFIG_RACK_JAVA_GUI" = "y"])
if test x"$CONFIG_RACK_JAVA_GUI" = "xy"; then
    AC_DEFINE(CONFIG_RACK_JAVA_GUI,1,[building java gui])
fi

AC_SUBST(CONFIG_RACK_JAVA_GUI)

dnl -----------------------------------------------------------------
dnl  javac & jar
dnl -----------------------------------------------------------------

if test x"$CONFIG_RACK_JAVA" = "xy"; then

    AC_MSG_CHECKING([javac])
    JAVAC="`which javac`"
    if test \! -x ${JAVAC}; then
        AC_MSG_ERROR([*** can't find javac])
    else
        AC_MSG_RESULT([${JAVAC}])
    fi

    AC_MSG_CHECKING([jar])
    JAR="`which jar`"
    if test \! -x ${JAR}; then
        AC_MSG_ERROR([*** can't find jar])
    else
        AC_MSG_RESULT([${JAR}])
    fi
fi

dnl -----------------------------------------------------------------
dnl  ...
dnl -----------------------------------------------------------------

dnl ======================================================================
dnl    project modules
dnl ======================================================================

dnl -----------------------------------------------------------------
dnl  drivers - CameraDcam
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build CameraDcam])
AC_ARG_ENABLE(camera-dcam,
    AS_HELP_STRING([--enable-camera-dcam], [building CameraDcam]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CAMERA_DCAM=y ;;
        *) CONFIG_RACK_CAMERA_DCAM=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CAMERA_DCAM:-n}])
AM_CONDITIONAL(CONFIG_RACK_CAMERA_DCAM,[test "$CONFIG_RACK_CAMERA_DCAM" = "y"])
if test "$CONFIG_RACK_CAMERA_DCAM" = "y"; then
    AC_DEFINE(CONFIG_RACK_CAMERA_DCAM,1,[building CameraDcam])
    CONFIG_RACK_LIBRAW1394_SUPPORT=y
    CONFIG_RACK_LIBDC1394_SUPPORT=y
fi


dnl -----------------------------------------------------------------
dnl  drivers - CameraJpeg
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build CameraJpeg])
AC_ARG_ENABLE(camera-jpeg,
    AS_HELP_STRING([--enable-camera-jpeg], [building CameraJpeg]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CAMERA_JPEG=y ;;
        *) CONFIG_RACK_CAMERA_JPEG=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CAMERA_JPEG:-n}])
AM_CONDITIONAL(CONFIG_RACK_CAMERA_JPEG,[test "$CONFIG_RACK_CAMERA_JPEG" = "y"])
if test "$CONFIG_RACK_CAMERA_JPEG" = "y"; then
    AC_DEFINE(CONFIG_RACK_CAMERA_JPEG,1,[building CameraJpeg])
    CONFIG_RACK_LIBJPEG_SUPPORT=y
fi

dnl -----------------------------------------------------------------
dnl  drivers - CameraV4l
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build CameraV4l])
AC_ARG_ENABLE(camera-v4l,
    AS_HELP_STRING([--enable-camera-v4l], [building CameraV4l]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CAMERA_V4L=y ;;
        *) CONFIG_RACK_CAMERA_V4L=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CAMERA_V4L:-n}])
AM_CONDITIONAL(CONFIG_RACK_CAMERA_V4L,[test "$CONFIG_RACK_CAMERA_V4L" = "y"])
if test "$CONFIG_RACK_CAMERA_V4L" = "y"; then
    AC_DEFINE(CONFIG_RACK_CAMERA_V4L,1,[building CameraV4l])
fi

dnl -----------------------------------------------------------------
dnl  drivers - ChassisPioneer
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build ChassisPioneer])
AC_ARG_ENABLE(chassis-pioneer,
    AS_HELP_STRING([--enable-chassis-pioneer], [building ChassisPioneer]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CHASSIS_PIONEER=y ;;
        *) CONFIG_RACK_CHASSIS_PIONEER=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CHASSIS_PIONEER:-n}])
AM_CONDITIONAL(CONFIG_RACK_CHASSIS_PIONEER,[test "$CONFIG_RACK_CHASSIS_PIONEER" = "y"])
if test "$CONFIG_RACK_CHASSIS_PIONEER" = "y"; then
    AC_DEFINE(CONFIG_RACK_CHASSIS_PIONEER,1,[building ChassisPioneer])
fi

dnl -----------------------------------------------------------------
dnl  drivers - ChassisEr1
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build ChassisEr1])
AC_ARG_ENABLE(chassis-er1,
    AS_HELP_STRING([--enable-chassis-er1], [building ChassisEr1]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CHASSIS_ER1=y ;;
        *) CONFIG_RACK_CHASSIS_ER1=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CHASSIS_ER1:-n}])
AM_CONDITIONAL(CONFIG_RACK_CHASSIS_ER1,[test "$CONFIG_RACK_CHASSIS_ER1" = "y"])
if test "$CONFIG_RACK_CHASSIS_ER1" = "y"; then
    AC_DEFINE(CONFIG_RACK_CHASSIS_ER1,1,[building ChassisEr1])
fi

dnl -----------------------------------------------------------------
dnl  drivers - ChassisSim
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build ChassisSim])
AC_ARG_ENABLE(chassis-sim,
    AS_HELP_STRING([--enable-chassis-sim], [building ChassisSim]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CHASSIS_SIM=y ;;
        *) CONFIG_RACK_CHASSIS_SIM=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CHASSIS_SIM:-n}])
AM_CONDITIONAL(CONFIG_RACK_CHASSIS_SIM,[test "$CONFIG_RACK_CHASSIS_SIM" = "y"])
if test "$CONFIG_RACK_CHASSIS_SIM" = "y"; then
    AC_DEFINE(CONFIG_RACK_CHASSIS_SIM,1,[building ChassisSim])
fi

dnl -----------------------------------------------------------------
dnl  drivers - ChassisUsarsim
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build ChassisUsarsim])
AC_ARG_ENABLE(chassis-usarsim,
    AS_HELP_STRING([--enable-chassis-usarsim], [building ChassisUsarsim]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CHASSIS_USARSIM=y ;;
        *) CONFIG_RACK_CHASSIS_USARSIM=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CHASSIS_USARSIM:-n}])
AM_CONDITIONAL(CONFIG_RACK_CHASSIS_USARSIM,[test "$CONFIG_RACK_CHASSIS_USARSIM" = "y"])
if test "$CONFIG_RACK_CHASSIS_USARSIM" = "y"; then
    AC_DEFINE(CONFIG_RACK_CHASSIS_USARSIM,1,[building ChassisUsarsim])
fi

dnl -----------------------------------------------------------------
dnl  drivers - ChassisRoomba
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build ChassisRoomba])
AC_ARG_ENABLE(chassis-roomba,
    AS_HELP_STRING([--enable-chassis-roomba], [building ChassisRoomba]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CHASSIS_ROOMBA=y ;;
        *) CONFIG_RACK_CHASSIS_ROOMBA=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CHASSIS_ROOMBA:-n}])
AM_CONDITIONAL(CONFIG_RACK_CHASSIS_ROOMBA,[test "$CONFIG_RACK_CHASSIS_ROOMBA" = "y"])
if test "$CONFIG_RACK_CHASSIS_ROOMBA" = "y"; then
    AC_DEFINE(CONFIG_RACK_CHASSIS_ROOMBA,1,[building ChassisRoomba])
fi

dnl -----------------------------------------------------------------
dnl  drivers - ClockDcf77EmcPro
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build ClockDcf77EmcPro])
AC_ARG_ENABLE(clock-dcf77-emc-pro,
    AS_HELP_STRING([--enable-clock-dcf77-emc-pro], [building ClockDcf77EmcPro]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CLOCK_DCF77_EMC_PRO=y ;;
        *) CONFIG_RACK_CLOCK_DCF77_EMC_PRO=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CLOCK_DCF77_EMC_PRO:-n}])
AM_CONDITIONAL(CONFIG_RACK_CLOCK_DCF77_EMC_PRO,[test "$CONFIG_RACK_CLOCK_DCF77_EMC_PRO" = "y"])
if test "$CONFIG_RACK_CLOCK_DCF77_EMC_PRO" = "y"; then
    AC_DEFINE(CONFIG_RACK_CLOCK_DCF77_EMC_PRO,1,[building ClockDcf77EmcPro])
fi

dnl -----------------------------------------------------------------
dnl  drivers - ClockDcf77MbgC51
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build ClockDcf77MbgC51])
AC_ARG_ENABLE(clock-dcf77-mbg-c51,
    AS_HELP_STRING([--enable-clock-dcf77-mbg-c51], [building ClockDcf77MbgC51]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CLOCK_DCF77_MBG_C51=y ;;
        *) CONFIG_RACK_CLOCK_DCF77_MBG_C51=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CLOCK_DCF77_MBG_C51:-n}])
AM_CONDITIONAL(CONFIG_RACK_CLOCK_DCF77_MBG_C51,[test "$CONFIG_RACK_CLOCK_DCF77_MBG_C51" = "y"])
if test "$CONFIG_RACK_CLOCK_DCF77_MBG_C51" = "y"; then
    AC_DEFINE(CONFIG_RACK_CLOCK_DCF77_MBG_C51,1,[building ClockDcf77MbgC51])
fi

dnl -----------------------------------------------------------------
dnl  drivers - ClockSystem
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build ClockSystem])
AC_ARG_ENABLE(clock-system,
    AS_HELP_STRING([--enable-clock-system], [building ClockSystem]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_CLOCK_SYSTEM=y ;;
        *) CONFIG_RACK_CLOCK_SYSTEM=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_CLOCK_SYSTEM:-n}])
AM_CONDITIONAL(CONFIG_RACK_CLOCK_SYSTEM,[test "$CONFIG_RACK_CLOCK_SYSTEM" = "y"])
if test "$CONFIG_RACK_CLOCK_SYSTEM" = "y"; then
    AC_DEFINE(CONFIG_RACK_CLOCK_SYSTEM,1,[building ClockSystem])
fi

dnl -----------------------------------------------------------------
dnl  drivers - CompassCmps03
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build CompassCmps03])
AC_ARG_ENABLE(compass-cmps03,
    AS_HELP_STRING([--enable-compass-cmps03], [building CompassCmps03]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_COMPASS_CMPOS03=y ;;
        *) CONFIG_RACK_COMPASS_CMPS03=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_COMPASS_CMPS03:-n}])
AM_CONDITIONAL(CONFIG_RACK_COMPASS_CMPS03,[test "$CONFIG_RACK_COMPASS_CMPS03" = "y"])
if test "$CONFIG_RACK_COMPASS_CMPS03" = "y"; then
    AC_DEFINE(CONFIG_RACK_COMPASS_CMPS03,1,[building CompassCmps03])
fi

dnl -----------------------------------------------------------------
dnl  drivers - GpsNmea
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build GpsNmea])
AC_ARG_ENABLE(gps-nmea,
    AS_HELP_STRING([--enable-gps-nmea], [building GpsNmea]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_GPS_NMEA=y ;;
        *) CONFIG_RACK_GPS_NMEA=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_GPS_NMEA:-n}])
AM_CONDITIONAL(CONFIG_RACK_GPS_NMEA,[test "$CONFIG_RACK_GPS_NMEA" = "y"])
if test "$CONFIG_RACK_GPS_NMEA" = "y"; then
    AC_DEFINE(CONFIG_RACK_GPS_NMEA,1,[building GpsNmea])
fi

dnl -----------------------------------------------------------------
dnl  drivers - GyroXsens
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build GyroXsens])
AC_ARG_ENABLE(gyro-xsens,
    AS_HELP_STRING([--enable-gyro-xsens], [building GyroXsens]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_GYRO_XSENS=y ;;
        *) CONFIG_RACK_GYRO_XSENS=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_GYRO_XSENS:-n}])
AM_CONDITIONAL(CONFIG_RACK_GYRO_XSENS,[test "$CONFIG_RACK_GYRO_XSENS" = "y"])
if test "$CONFIG_RACK_GYRO_XSENS" = "y"; then
    AC_DEFINE(CONFIG_RACK_GYRO_XSENS,1,[building GyroXsens])
fi

dnl -----------------------------------------------------------------
dnl  drivers - LadarHokuyoUrg
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build LadarHokuyoUrg])
AC_ARG_ENABLE(ladar-hokuyo-urg,
    AS_HELP_STRING([--enable-ladar-hokuyo-urg], [building LadarHokuyoUrg]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LADAR_HOKUYO_URG=y ;;
        *) CONFIG_RACK_LADAR_HOKUYO_URG=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_LADAR_HOKUYO_URG:-n}])
AM_CONDITIONAL(CONFIG_RACK_LADAR_HOKUYO_URG,[test "$CONFIG_RACK_LADAR_HOKUYO_URG" = "y"])
if test "$CONFIG_RACK_LADAR_HOKUYO_URG" = "y"; then
    AC_DEFINE(CONFIG_RACK_LADAR_HOKUYO_URG,1,[building LadarHokuyoUrg])
fi

dnl -----------------------------------------------------------------
dnl  drivers - LadarHokuyoUrgUsb
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build LadarHokuyoUrgUsb])
AC_ARG_ENABLE(ladar-hokuyo-urg-usb,
    AS_HELP_STRING([--enable-ladar-hokuyo-urg-usb], [building LadarHokuyoUrgUsb]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LADAR_HOKUYO_URG_USB=y ;;
        *) CONFIG_RACK_LADAR_HOKUYO_URG_USB=n ;;
    esac])     
AC_MSG_RESULT([${CONFIG_RACK_LADAR_HOKUYO_URG_USB:-n}])
AM_CONDITIONAL(CONFIG_RACK_LADAR_HOKUYO_URG_USB,[test "$CONFIG_RACK_LADAR_HOKUYO_URG_USB" = "y"])
if test "$CONFIG_RACK_LADAR_HOKUYO_URG_USB" = "y"; then
    AC_DEFINE(CONFIG_RACK_LADAR_HOKUYO_URG_USB,1,[building LadarHokuyoUrgUsb])
fi  

dnl -----------------------------------------------------------------
dnl  drivers - LadarIbeo
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build LadarIbeo])
AC_ARG_ENABLE(ladar-ibeo,
    AS_HELP_STRING([--enable-ladar-ibeo], [building LadarIbeo]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LADAR_IBEO=y ;;
        *) CONFIG_RACK_LADAR_IBEO=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_LADAR_IBEO:-n}])
AM_CONDITIONAL(CONFIG_RACK_LADAR_IBEO,[test "$CONFIG_RACK_LADAR_IBEO" = "y"])
if test "$CONFIG_RACK_LADAR_IBEO" = "y"; then
    AC_DEFINE(CONFIG_RACK_LADAR_IBEO,1,[building LadarIbeo])
fi

dnl -----------------------------------------------------------------
dnl  drivers - LadarIbeoLux
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build LadarIbeoLux])
AC_ARG_ENABLE(ladar-ibeo-lux,
    AS_HELP_STRING([--enable-ladar-ibeo-lux], [building LadarIbeoLux]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LADAR_IBEO_LUX=y ;;
        *) CONFIG_RACK_LADAR_IBEO_LUX=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_LADAR_IBEO_LUX:-n}])
AM_CONDITIONAL(CONFIG_RACK_LADAR_IBEO_LUX,[test "$CONFIG_RACK_LADAR_IBEO_LUX" = "y"])
if test "$CONFIG_RACK_LADAR_IBEO_LUX" = "y"; then
    AC_DEFINE(CONFIG_RACK_LADAR_IBEO_LUX,1,[building LadarIbeoLux])
fi

dnl -----------------------------------------------------------------
dnl  drivers - LadarSickLms200
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build LadarSickLms200])
AC_ARG_ENABLE(ladar-sick-lms200,
    AS_HELP_STRING([--enable-ladar-sick-lms200], [building LadarSickLms200]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LADAR_SICK_LMS200=y ;;
        *) CONFIG_RACK_LADAR_SICK_LMS200=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_LADAR_SICK_LMS200:-n}])
AM_CONDITIONAL(CONFIG_RACK_LADAR_SICK_LMS200,[test "$CONFIG_RACK_LADAR_SICK_LMS200" = "y"])
if test "$CONFIG_RACK_LADAR_SICK_LMS200" = "y"; then
    AC_DEFINE(CONFIG_RACK_LADAR_SICK_LMS200,1,[building LadarSickLms200])
fi

dnl -----------------------------------------------------------------
dnl  drivers - LadarSickS
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build LadarSickS])
AC_ARG_ENABLE(ladar-sick-s,
    AS_HELP_STRING([--enable-ladar-sick-s], [building LadarSickS]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LADAR_SICK_S=y ;;
        *) CONFIG_RACK_LADAR_SICK_S=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_LADAR_SICK_S:-n}])
AM_CONDITIONAL(CONFIG_RACK_LADAR_SICK_S,[test "$CONFIG_RACK_LADAR_SICK_S" = "y"])
if test "$CONFIG_RACK_LADAR_SICK_S" = "y"; then
    AC_DEFINE(CONFIG_RACK_LADAR_SICK_S,1,[building LadarSickS])
fi

dnl -----------------------------------------------------------------
dnl  drivers - LadarSickLms100
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build LadarSickLms100])
AC_ARG_ENABLE(ladar-sick-lms100,
    AS_HELP_STRING([--enable-ladar-sick-lms100], [building LadarSickLms100]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LADAR_SICK_LMS100=y ;;
        *) CONFIG_RACK_LADAR_SICK_LMS100=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_LADAR_SICK_LMS100:-n}])
AM_CONDITIONAL(CONFIG_RACK_LADAR_SICK_LMS100,[test "$CONFIG_RACK_LADAR_SICK_LMS100" = "y"])
if test "$CONFIG_RACK_LADAR_SICK_LMS100" = "y"; then
    AC_DEFINE(CONFIG_RACK_LADAR_SICK_LMS100,1,[building LadarSickLms100])
fi

dnl -----------------------------------------------------------------
dnl  drivers - LadarSim
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build LadarSim])
AC_ARG_ENABLE(ladar-sm,
    AS_HELP_STRING([--enable-ladar-sim], [building LadarSim]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_LADAR_SIM=y ;;
        *) CONFIG_RACK_LADAR_SIM=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_LADAR_SIM:-n}])
AM_CONDITIONAL(CONFIG_RACK_LADAR_SIM,[test "$CONFIG_RACK_LADAR_SIM" = "y"])
if test "$CONFIG_RACK_LADAR_SIM" = "y"; then
    AC_DEFINE(CONFIG_RACK_LADAR_SIM,1,[building LadarSim])
fi

dnl -----------------------------------------------------------------
dnl  navigation - OdometryChassis
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build OdometryChassis])
AC_ARG_ENABLE(odometry-chassis,
    AS_HELP_STRING([--enable-odometry-chassis], [building OdometryChassis]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_ODOMETRY_CHASSIS=y ;;
        *) CONFIG_RACK_ODOMETRY_CHASSIS=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_ODOMETRY_CHASSIS:-n}])
AM_CONDITIONAL(CONFIG_RACK_ODOMETRY_CHASSIS,[test "$CONFIG_RACK_ODOMETRY_CHASSIS" = "y"])
if test "$CONFIG_RACK_ODOMETRY_CHASSIS" = "y"; then
    AC_DEFINE(CONFIG_RACK_ODOMETRY_CHASSIS,1,[building OdometryChassis])
fi

dnl -----------------------------------------------------------------
dnl  navigation - PilotJoystick
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build PilotJoystick])
AC_ARG_ENABLE(pilot-joystick,
    AS_HELP_STRING([--enable-pilot-joystick], [building PilotJoystick]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_PILOT_JOYSTICK=y ;;
        *) CONFIG_RACK_PILOT_JOYSTICK=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_PILOT_JOYSTICK:-n}])
AM_CONDITIONAL(CONFIG_RACK_PILOT_JOYSTICK,[test "$CONFIG_RACK_PILOT_JOYSTICK" = "y"])
if test "$CONFIG_RACK_PILOT_JOYSTICK" = "y"; then
    AC_DEFINE(CONFIG_RACK_PILOT_JOYSTICK,1,[building PilotJoystick])
fi

dnl -----------------------------------------------------------------
dnl  navigation - PilotWallFollowing
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build PilotWallFollowing])
AC_ARG_ENABLE(pilot-wall-following,
    AS_HELP_STRING([--enable-pilot-wall-following], [building PilotWallFollowing]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_PILOT_WALL_FOLLOWING=y ;;
        *) CONFIG_RACK_PILOT_WALL_FOLLOWING=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_PILOT_WALL_FOLLOWING:-n}])
AM_CONDITIONAL(CONFIG_RACK_PILOT_WALL_FOLLOWING,[test "$CONFIG_RACK_PILOT_WALL_FOLLOWING" = "y"])
if test "$CONFIG_RACK_PILOT_WALL_FOLLOWING" = "y"; then
    AC_DEFINE(CONFIG_RACK_PILOT_WALL_FOLLOWING,1,[building PilotWallFollowing])
fi

dnl -----------------------------------------------------------------
dnl  navigation - PilotLab
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build PilotLab])
AC_ARG_ENABLE(pilot-lab,
    AS_HELP_STRING([--enable-pilot-lab], [building PilotLab]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_PILOT_LAB=y ;;
        *) CONFIG_RACK_PILOT_LAB=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_PILOT_LAB:-n}])
AM_CONDITIONAL(CONFIG_RACK_PILOT_LAB,[test "$CONFIG_RACK_PILOT_LAB" = "y"])
if test "$CONFIG_RACK_PILOT_LAB" = "y"; then
    AC_DEFINE(CONFIG_RACK_PILOT_LAB,1,[building PilotLab])
fi


dnl -----------------------------------------------------------------
dnl  navigation - Position
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build Position])
AC_ARG_ENABLE(position,
    AS_HELP_STRING([--enable-position], [building Position]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_POSITION=y ;;
        *) CONFIG_RACK_POSITION=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_POSITION:-n}])
AM_CONDITIONAL(CONFIG_RACK_POSITION,[test "$CONFIG_RACK_POSITION" = "y"])
if test "$CONFIG_RACK_POSITION" = "y"; then
    AC_DEFINE(CONFIG_RACK_POSITION,1,[building Position])
fi

dnl -----------------------------------------------------------------
dnl  perception - Scan2d
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build Scan2d])
AC_ARG_ENABLE(scan2d,
    AS_HELP_STRING([--enable-scan2d], [building Scan2d]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_SCAN2D=y ;;
        *) CONFIG_RACK_SCAN2D=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_SCAN2D:-n}])
AM_CONDITIONAL(CONFIG_RACK_SCAN2D,[test "$CONFIG_RACK_SCAN2D" = "y"])
if test "$CONFIG_RACK_SCAN2D" = "y"; then
    AC_DEFINE(CONFIG_RACK_SCAN2D,1,[building Scan2d])
fi

dnl -----------------------------------------------------------------
dnl  perception - Scan2dDynObjRecog
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build Scan2dDynObjRecog])
AC_ARG_ENABLE(scan2d-dyn-obj-recog,
    AS_HELP_STRING([--enable-scan2d-dyn-obj-recog], [building Scan2dDynObjRecog]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_SCAN2D_DYN_OBJ_RECOG=y ;;
        *) CONFIG_RACK_SCAN2D_DYN_OBJ_RECOG=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_SCAN2D_DYN_OBJ_RECOG:-n}])
AM_CONDITIONAL(CONFIG_RACK_SCAN2D_DYN_OBJ_RECOG,[test "$CONFIG_RACK_SCAN2D_DYN_OBJ_RECOG" = "y"])
if test "$CONFIG_RACK_SCAN2D_DYN_OBJ_RECOG" = "y"; then
    AC_DEFINE(CONFIG_RACK_SCAN2D_DYN_OBJ_RECOG,1,[building Scan2dDynObjRecog])
fi

dnl -----------------------------------------------------------------
dnl  perception - Scan2dMerge
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build Scan2dMerge])
AC_ARG_ENABLE(scan2d-merge,
    AS_HELP_STRING([--enable-scan2d-merge], [building Scan2dMerge]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_SCAN2D_MERGE=y ;;
        *) CONFIG_RACK_SCAN2D_MERGE=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_SCAN2D_MERGE:-n}])
AM_CONDITIONAL(CONFIG_RACK_SCAN2D_MERGE,[test "$CONFIG_RACK_SCAN2D_MERGE" = "y"])
if test "$CONFIG_RACK_SCAN2D_MERGE" = "y"; then
    AC_DEFINE(CONFIG_RACK_SCAN2D_MERGE,1,[building Scan2dMerge])
fi

dnl -----------------------------------------------------------------
dnl  perception - Scan2dSim
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build Scan2dSim])
AC_ARG_ENABLE(scan2d-sim,
    AS_HELP_STRING([--enable-scan2d-sim], [building Scan2dSim]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_SCAN2D_SIM=y ;;
        *) CONFIG_RACK_SCAN2D_SIM=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_SCAN2D_SIM:-n}])
AM_CONDITIONAL(CONFIG_RACK_SCAN2D_SIM,[test "$CONFIG_RACK_SCAN2D_SIM" = "y"])
if test "$CONFIG_RACK_SCAN2D_SIM" = "y"; then
    AC_DEFINE(CONFIG_RACK_SCAN2D_SIM,1,[building Scan2dSim])
fi

dnl -----------------------------------------------------------------
dnl  perception - Scan2dLab
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build Scan2dLab])
AC_ARG_ENABLE(scan2d-lab,
    AS_HELP_STRING([--enable-scan2d-lab], [building Scan2dLab]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_SCAN2D_LAB=y ;;
        *) CONFIG_RACK_SCAN2D_LAB=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_SCAN2D_LAB:-n}])
AM_CONDITIONAL(CONFIG_RACK_SCAN2D_LAB,[test "$CONFIG_RACK_SCAN2D_LAB" = "y"])
if test "$CONFIG_RACK_SCAN2D_LAB" = "y"; then
    AC_DEFINE(CONFIG_RACK_SCAN2D_LAB,1,[building Scan2dLab])
fi

dnl -----------------------------------------------------------------
dnl  perception - ObjRecogIbeoLux
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build ObjRecogIbeoLux])
AC_ARG_ENABLE(obj-recog-ibeo-lux,
    AS_HELP_STRING([--enable-obj-recog-ibeo-lux], [building ObjRecogIbeoLux]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_OBJ_RECOG_IBEO_LUX=y ;;
        *) CONFIG_RACK_OBJ_RECOG_IBEO_LUX=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_OBJ_RECOG_IBEO_LUX:-n}])
AM_CONDITIONAL(CONFIG_RACK_OBJ_RECOG_IBEO_LUX,[test "$CONFIG_RACK_OBJ_RECOG_IBEO_LUX" = "y"])
if test "$CONFIG_RACK_OBJ_RECOG_IBEO_LUX" = "y"; then
    AC_DEFINE(CONFIG_RACK_OBJ_RECOG_IBEO_LUX,1,[building ObjRecogIbeoLux])
fi

dnl -----------------------------------------------------------------
dnl  perception - ObjRecogRelayLadar
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build ObjRecogRelayLadar])
AC_ARG_ENABLE(obj-recog-relay-ladar,
    AS_HELP_STRING([--enable-obj-recog-relay-ladar], [building ObjRecogRelayLadar]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_OBJ_RECOG_RELAY_LADAR=y ;;
        *) CONFIG_RACK_OBJ_RECOG_RELAY_LADAR=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_OBJ_RECOG_RELAY_LADAR:-n}])
AM_CONDITIONAL(CONFIG_RACK_OBJ_RECOG_RELAY_LADAR,[test "$CONFIG_RACK_OBJ_RECOG_RELAY_LADAR" = "y"])
if test "$CONFIG_RACK_OBJ_RECOG_RELAY_LADAR" = "y"; then
    AC_DEFINE(CONFIG_RACK_OBJ_RECOG_RELAY_LADAR,1,[building ObjRecogRelayLadar])
fi

dnl -----------------------------------------------------------------
dnl  skel - DummyAbc
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build DummyAbc])
AC_ARG_ENABLE(dummy-abc,
    AS_HELP_STRING([--enable-dummy-abc], [building DummyAbc]),
    [case "$enableval" in
        y | yes) CONFIG_RACK_DUMMY_ABC=y ;;
        *) CONFIG_RACK_DUMMY_ABC=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_RACK_DUMMY_ABC:-n}])
AM_CONDITIONAL(CONFIG_RACK_DUMMY_ABC,[test "$CONFIG_RACK_DUMMY_ABC" = "y"])
if test "$CONFIG_RACK_DUMMY_ABC" = "y"; then
    AC_DEFINE(CONFIG_RACK_DUMMY_ABC,1,[building DummyAbc])
fi

dnl -----------------------------------------------------------------
dnl  tools - DatalogRec
dnl -----------------------------------------------------------------

AC_MSG_CHECKING([build DatalogRec])
AC_ARG_ENABLE(datalog-rec,
    AS_HELP_STRING([--enable-datalog-rec], [building DatalogRec]),
    [case "$enableval" in
        y | yes) CONFIG_DATALOG_REC=y ;;
        *) CONFIG_DATALOG_REC=n ;;
    esac])
AC_MSG_RESULT([${CONFIG_DATALOG_REC:-n}])
AM_CONDITIONAL(CONFIG_DATALOG_REC,[test "$CONFIG_DATALOG_REC" = "y"])
if test "$CONFIG_DATALOG_REC" = "y"; then
    AC_DEFINE(CONFIG_DATALOG_REC,1,[building DatalogRec])
fi

dnl ======================================================================
dnl  directory / library checks
dnl ======================================================================

RACK_KMOD_CFLAGS=""
RACK_SUPPORTS=""

dnl ----- Xenomai --------------------------------------------------------
dnl
dnl  depends on nothing
dnl

AC_MSG_CHECKING([target os xenomai])
AC_MSG_RESULT([${CONFIG_RACK_OS_XENOMAI}])

XENOMAI_CPPFLAGS=""
XENOMAI_LDFLAGS=""
XENOMAI_LIBS=""

if test x"${CONFIG_RACK_OS_XENOMAI}" = x"y"; then

XENOMAI_CPPFLAGS="`${XENO_USER_CONFIG} --xeno-cflags`"
XENOMAI_LDFLAGS="`${XENO_USER_CONFIG} --xeno-ldflags`"
XENOMAI_LIBS="-lnative -lrtdm"
fi

AC_SUBST(XENOMAI_CPPFLAGS)
AC_SUBST(XENOMAI_LDFLAGS)
AC_SUBST(XENOMAI_LIBS)

AM_CONDITIONAL(CONFIG_RACK_OS_XENOMAI,
               [test x"${CONFIG_RACK_OS_XENOMAI}" = "xy"])

dnl ----- Linux --------------------------------------------------------
dnl
dnl  depends on nothing
dnl

AC_MSG_CHECKING([target os linux])
AC_MSG_RESULT([${CONFIG_RACK_OS_LINUX}])

LINUX_CPPFLAGS=""
LINUX_LDFLAGS=""
LINUX_LIBS="-lpthread"

AC_SUBST(LINUX_CPPFLAGS)
AC_SUBST(LINUX_LDFLAGS)
AC_SUBST(LINUX_LIBS)

AM_CONDITIONAL(CONFIG_RACK_OS_LINUX,
               [test x"${CONFIG_RACK_OS_LINUX}" = "xy"])

dnl ----- rtnet ----------------------------------------------------------------
dnl
dnl  depends on xenomai
dnl  provides headers: yes
dnl  provides libs:    no
dnl

AC_MSG_CHECKING([rtnet support])
AC_MSG_RESULT([${CONFIG_RACK_RTNET_SUPPORT}])

RTNET_CPPFLAGS=""

if test x"${CONFIG_RACK_RTNET_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_RTNETDIR" \!= "xy"; then
        CONFIG_RACK_RTNETDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/rtnet"
    fi

    cppflags_backup="${CPPFLAGS}"
    if test x${CONFIG_RACK_RTNETDIR} != "x"; then
        AC_MSG_CHECKING([rtnet directory])
        if test -d ${CONFIG_RACK_RTNETDIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_RTNETDIR}])

            RTNET_CPPFLAGS="-I${CONFIG_RACK_RTNETDIR}/include"

            CPPFLAGS="${XENOMAI_CPPFLAGS} ${CPPFLAGS}"
            CPPFLAGS="${RTNET_CPPFLAGS} ${CPPFLAGS}"
        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_RTNETDIR})
        fi
    fi

    AC_CHECK_HEADER(rtnet.h,,
                    [AC_MSG_ERROR(cannot find rtnet.h)]
                   )

    RACK_SUPPORTS="rtnet ${RACK_SUPPORTS}"
    CPPFLAGS="${cppflags_backup}"
fi

AC_SUBST(RTNET_CPPFLAGS)
AM_CONDITIONAL(CONFIG_RACK_RTNET_SUPPORT,
               [test x"${CONFIG_RACK_RTNET_SUPPORT}" = "xy"])

dnl ----- libraw1394 -----------------------------------------------------------
dnl
dnl  depends on nothing
dnl  provides headers: yes
dnl  provides libs:    yes
dnl

AC_MSG_CHECKING([libraw1394 support])
AC_MSG_RESULT([${CONFIG_RACK_LIBRAW1394_SUPPORT}])

LIBRAW1394_CPPFLAGS=""
LIBRAW1394_LDFLAGS=""
LIBRAW1394_LIBS=""

if test x"${CONFIG_RACK_LIBRAW1394_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_LIBRAW1394DIR" \!= "xy"; then
        CONFIG_RACK_LIBRAW1394DIR="${CONFIG_RACK_LIRE_INSTALLDIR}/libraw1394"
    fi

    cppflags_backup="${CPPFLAGS}"
    ldflags_backup="${LDFLAGS}"
    libs_backup="${LIBS}"

    if test x${CONFIG_RACK_LIBRAW1394DIR} != "x"; then
        AC_MSG_CHECKING([libraw1394 directory])
        if test -d ${CONFIG_RACK_LIBRAW1394DIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_LIBRAW1394DIR}])

            LIBRAW1394_CPPFLAGS="-I${CONFIG_RACK_LIBRAW1394DIR}/include"
            LIBRAW1394_LDFLAGS="-L${CONFIG_RACK_LIBRAW1394DIR}/lib -Wl,-rpath=${CONFIG_RACK_LIBRAW1394DIR}/lib"
            LIBRAW1394_LIBS="-lraw1394"

            CPPFLAGS="${LIBRAW1394_CPPFLAGS} ${CPPFLAGS}"
            LDFLAGS="${LIBRAW1394_LDFLAGS} ${LDFLAGS}"
            LIBS="$LIBRAW394_LIBS"

        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_LIBRAW1394DIR})
        fi
    fi

    AC_CHECK_HEADER([libraw1394/raw1394.h],
                    AC_CHECK_LIB(raw1394,
                                 raw1394_new_handle,,
                                 [AC_MSG_ERROR(cannot find function raw1394_new_handle)]
                                ),
                    [AC_MSG_ERROR(cannot find libraw1394 header files)]
                   )

    RACK_SUPPORTS="libraw1394 ${RACK_SUPPORTS}"
    CPPFLAGS="${cppflags_backup}"
    LDFLAGS="${ldflags_backup}"
    LIBS="${libs_backup}"
fi

AC_SUBST(LIBRAW1394_CPPFLAGS)
AC_SUBST(LIBRAW1394_LDFLAGS)
AC_SUBST(LIBRAW1394_LIBS)
AM_CONDITIONAL(CONFIG_RACK_LIBRAW1394_SUPPORT,
               [test x"${CONFIG_RACK_LIBRAW1394_SUPPORT}" = "xy"])

dnl ----- libdc1394_control ----------------------------------------------------
dnl
dnl  depends on libraw1394
dnl  provides headers: yes
dnl  provides libs:    yes
dnl

AC_MSG_CHECKING([libdc1394 support])
AC_MSG_RESULT([${CONFIG_RACK_LIBDC1394_SUPPORT}])

LIBDC1394_CPPFLAGS=""
LIBDC1394_LDFLAGS=""
LIBDC1394_LIBS=""

if test x"${CONFIG_RACK_LIBDC1394_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_LIBDC1394DIR" \!= "xy"; then
        CONFIG_RACK_LIBDC1394DIR="${CONFIG_RACK_LIRE_INSTALLDIR}/libdc1394"
    fi

    cppflags_backup="${CPPFLAGS}"
    ldflags_backup="${LDFLAGS}"
    libs_backup="${LIBS}"

    if test x${CONFIG_RACK_LIBDC1394DIR} != "x"; then
        AC_MSG_CHECKING([libdc1394 directory])
        if test -d ${CONFIG_RACK_LIBDC1394DIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_LIBDC1394DIR}])

            LIBDC1394_CPPFLAGS="-I${CONFIG_RACK_LIBDC1394DIR}/include"
            LIBDC1394_LDFLAGS="-L${CONFIG_RACK_LIBDC1394DIR}/lib -Wl,-rpath=${CONFIG_RACK_LIBDC1394DIR}/lib"
            LIBDC1394_LIBS="-ldc1394"

            CPPFLAGS="${LIBRAW1394_CPPFLAGS} ${CPPFLAGS}"
            LDFLAGS="${LIBRAW1394_LDFLAGS} ${LDFLAGS}"
            LIBS="$LIBRAW394_LIBS"

            CPPFLAGS="${LIBDC1394_CPPFLAGS} ${CPPFLAGS}"
            LDFLAGS="${LIBDC1394_LDFLAGS} ${LDFLAGS}"
            LIBS="$LIBDC1394_LIBS"
        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_LIBDC1394DIR})
        fi
    fi

    AC_CHECK_HEADER([dc1394/dc1394.h],
                    AC_CHECK_LIB(dc1394,
                                 dc1394_camera_enumerate,,
                                 [AC_MSG_ERROR(cannot find function dc1394_camera_enumerate)]
                                ),
                    [AC_MSG_ERROR(cannot find libdc1394 header files)]
                   )

    RACK_SUPPORTS="libdc1394 ${RACK_SUPPORTS}"
    CPPFLAGS="${cppflags_backup}"
    LDFLAGS="${ldflags_backup}"
    LIBS="${libs_backup}"
fi

AC_SUBST(LIBDC1394_CPPFLAGS)
AC_SUBST(LIBDC1394_LDFLAGS)
AC_SUBST(LIBDC1394_LIBS)
AM_CONDITIONAL(CONFIG_RACK_LIBDC1394_SUPPORT,
               [test x"${CONFIG_RACK_LIBDC1394_SUPPORT}" = "xy"])

dnl ----- libjpeg --------------------------------------------------------------
dnl
dnl  depends on nothing
dnl  provides headers: yes
dnl  provides libs:    yes
dnl

AC_MSG_CHECKING([libjpeg support])
AC_MSG_RESULT([${CONFIG_RACK_LIBJPEG_SUPPORT}])

LIBJPEG_CPPFLAGS=""
LIBJPEG_LDFLAGS=""
LIBJPEG_LIBS=""

if test x"${CONFIG_RACK_LIBJPEG_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_LIBJPEGDIR" \!= "xy"; then
        CONFIG_RACK_LIBJPEGDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/libjpeg"
    fi

    cppflags_backup="${CPPFLAGS}"
    ldflags_backup="${LDFLAGS}"
    libs_backup="${LIBS}"

    if test x${CONFIG_RACK_LIBJPEGDIR} != "x"; then
        AC_MSG_CHECKING([libjpeg directory])
        if test -d ${CONFIG_RACK_LIBJPEGDIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_LIBJPEGDIR}])

            LIBJPEG_CPPFLAGS="-I${CONFIG_RACK_LIBJPEGDIR}/include"
            LIBJPEG_LDFLAGS="-L${CONFIG_RACK_LIBJPEGDIR}/lib -Wl,-rpath=${CONFIG_RACK_LIBJPEGDIR}/lib"
            LIBJPEG_LIBS="-ljpeg"

            CPPFLAGS="${LIBJPEG_CPPFLAGS} ${CPPFLAGS}"
            LDFLAGS="${LIBJPEG_LDFLAGS} ${LDFLAGS}"
            LIBS="$LIBJPEG_LIBS"
        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_LIBJPEGDIR})
        fi
    fi

    AC_CHECK_HEADER(jpeglib.h,
                    AC_CHECK_LIB(jpeg,
                                 jpeg_start_compress,,
                                 [AC_MSG_ERROR(cannot find function jpeg_create_compress)]
                                ),
                    [AC_MSG_ERROR(cannot find libjpeg header files)]
                   )

    RACK_SUPPORTS="libjpeg ${RACK_SUPPORTS}"
    CPPFLAGS="${cppflags_backup}"
    LDFLAGS="${ldflags_backup}"
    LIBS="${libs_backup}"
fi

AC_SUBST(LIBJPEG_CPPFLAGS)
AC_SUBST(LIBJPEG_LDFLAGS)
AC_SUBST(LIBJPEG_LIBS)
AM_CONDITIONAL(CONFIG_RACK_LIBJPEG_SUPPORT,
               [test x"${CONFIG_RACK_LIBJPEG_SUPPORT}" = "xy"])

dnl ----- zlib ---------------------------------------------------------------
dnl
dnl  depends on nothing
dnl  provides headers: yes
dnl  provides libs:    yes
dnl  TODO!

if test x"$CONFIG_RACK_EXT_ZLIBDIR" \!= "xy"; then
    CONFIG_RACK_ZLIBDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/zlib"
fi

dnl ----- libpng ---------------------------------------------------------------
dnl
dnl  depends on nothing
dnl  provides headers: yes
dnl  provides libs:    yes
dnl

AC_MSG_CHECKING([libpng support])
AC_MSG_RESULT([${CONFIG_RACK_LIBPNG_SUPPORT}])

if test x"${CONFIG_RACK_LIBPNG_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_LIBPNGDIR" \!= "xy"; then
        CONFIG_RACK_LIBPNGDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/libpng"
    fi

    cppflags_backup="${CPPFLAGS}"
    ldflags_backup="${LDFLAGS}"
    libs_backup="${LIBS}"

    LIBPNG_CPPFLAGS=""
    LIBPNG_LDFLAGS=""
    LIBPNG_LIBS=""

    if test x${CONFIG_RACK_LIBPNGDIR} != "x"; then
        AC_MSG_CHECKING([libpng directory])
        if test -d ${CONFIG_RACK_LIBPNGDIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_LIBPNGDIR}])

            LIBPNG_CPPFLAGS="-I${CONFIG_RACK_LIBPNGDIR}/include -I${CONFIG_RACK_ZLIBDIR}/include"
            LIBPNG_LDFLAGS="-L${CONFIG_RACK_LIBPNGDIR}/lib -Wl,-rpath=${CONFIG_RACK_LIBPNGDIR}/lib -L${CONFIG_RACK_ZLIBDIR}/lib -Wl,-rpath=${CONFIG_RACK_ZLIBDIR}/lib"
            LIBPNG_LIBS="-lpng"

            CPPFLAGS="${LIBPNG_CPPFLAGS} ${CPPFLAGS}"
            LDFLAGS="${LIBPNG_LDFLAGS} ${LDFLAGS}"
            LIBS="$LIBPNG_LIBS"
        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_LIBPNGDIR})
        fi
    fi

    AC_CHECK_HEADER(png.h,
                    AC_CHECK_LIB(png,
                                 png_write_end,,
                                 [AC_MSG_ERROR(cannot find function png_write_end)]
                                ),
                    [AC_MSG_ERROR(cannot find libpng header files)]
                   )

    RACK_SUPPORTS="libpng ${RACK_SUPPORTS}"

    AC_SUBST(LIBPNG_CPPFLAGS)
    AC_SUBST(LIBPNG_LDFLAGS)
    AC_SUBST(LIBPNG_LIBS)

    CPPFLAGS="${cppflags_backup}"
    LDFLAGS="${ldflags_backup}"
    LIBS="${libs_backup}"
fi

AM_CONDITIONAL(CONFIG_LIBPNG,
               [test x"${LIBPNG_LIBS}" != x""])

AM_CONDITIONAL(CONFIG_RACK_LIBPNG_SUPPORT,
               [test x"${CONFIG_RACK_LIBPNG_SUPPORT}" = "xy"])

dnl ----- opencv ---------------------------------------------------------------
dnl
dnl  depends on nothing
dnl  provides headers: yes
dnl  provides libs:    yes
dnl

AC_MSG_CHECKING([opencv support])
AC_MSG_RESULT([${CONFIG_RACK_OPENCV_SUPPORT}])

if test x"${CONFIG_RACK_OPENCV_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_OPENCVDIR" \!= "xy"; then
        CONFIG_RACK_OPENCVDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/opencv"
    fi

    cppflags_backup="${CPPFLAGS}"
    ldflags_backup="${LDFLAGS}"
    libs_backup="${LIBS}"

    OPENCV_CPPFLAGS=""
    OPENCV_LDFLAGS=""
    OPENCV_LIBS=""

    if test x${CONFIG_RACK_OPENCVDIR} != "x"; then
        AC_MSG_CHECKING([opencv directory])
        if test -d ${CONFIG_RACK_OPENCVDIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_OPENCVDIR}])

            OPENCV_CPPFLAGS="-I${CONFIG_RACK_OPENCVDIR}/include"
            OPENCV_LDFLAGS="${LIBPNG_LDFLAGS} ${LIBJPEG_LDFLAGS} ${LIBRAW1394_LDFLAGS} ${LIBDC1394_LDFLAGS} -L${CONFIG_RACK_OPENCVDIR}/lib -Wl,-rpath=${CONFIG_RACK_OPENCVDIR}/lib"
            OPENCV_LIBS="-lopencv_legacy -lopencv_objdetect"

            CPPFLAGS="${OPENCV_CPPFLAGS} ${CPPFLAGS}"
            LDFLAGS="${OPENCV_LDFLAGS} ${LDFLAGS}"
            LIBS="$OPENCV_LIBS"
        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_OPENCVDIR})
        fi
    fi

    AC_CHECK_HEADERS(opencv/cv.h opencv/cxcore.h opencv/highgui.h,
                    AC_CHECK_LIB(opencv_legacy,
                                 cvCreateData,,
                                 [AC_MSG_ERROR(cannot find function cvCreateData)]
                                )
                    AC_CHECK_LIB(opencv_legacy,
                                 cvFindFace,,
                                 [AC_MSG_ERROR(cannot find function cvFindFace)]
                                )
                    AC_CHECK_LIB(opencv_legacy,
                                 cvCreateSet,,
                                 [AC_MSG_ERROR(cannot find function cvCreateSet)]
                                )
                    AC_CHECK_LIB(opencv_legacy,
                                 cvShowImage,,
                                 [AC_MSG_ERROR(cannot find function cvShowImage)]
                                ),
                    [AC_MSG_ERROR(cannot find opencv header files)]
                   )

    RACK_SUPPORTS="opencv ${RACK_SUPPORTS}"

    AC_SUBST(OPENCV_CPPFLAGS)
    AC_SUBST(OPENCV_LDFLAGS)
    AC_SUBST(OPENCV_LIBS)

    CPPFLAGS="${cppflags_backup}"
    LDFLAGS="${ldflags_backup}"
    LIBS="${libs_backup}"
fi

AM_CONDITIONAL(CONFIG_OPENCV,
               [test x"${OPENCV_LIBS}" != x""])

AM_CONDITIONAL(CONFIG_RACK_OPENCV_SUPPORT,
               [test x"${CONFIG_RACK_OPENCV_SUPPORT}" = "xy"])

dnl ----- gsl ------------------------------------------------------------------
dnl
dnl  depends on nothing
dnl  provides headers: yes
dnl  provides libs:    yes
dnl

AC_MSG_CHECKING([gsl support])
AC_MSG_RESULT([${CONFIG_RACK_GSL_SUPPORT}])

if test x"${CONFIG_RACK_GSL_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_GSLDIR" \!= "xy"; then
        CONFIG_RACK_GSLDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/gsl"
    fi

    cppflags_backup="${CPPFLAGS}"
    ldflags_backup="${LDFLAGS}"
    libs_backup="${LIBS}"

    GSL_CPPFLAGS=""
    GSL_LDFLAGS=""
    GSL_LIBS=""

    if test x${CONFIG_RACK_GSLDIR} != "x"; then
        AC_MSG_CHECKING([gsl directory])
        if test -d ${CONFIG_RACK_GSLDIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_GSLDIR}])

            GSL_CPPFLAGS="-I${CONFIG_RACK_GSLDIR}/include"
            GSL_LDFLAGS="-L${CONFIG_RACK_GSLDIR}/lib -Wl,-rpath=${CONFIG_RACK_GSLDIR}/lib"
            GSL_LIBS="-lm -lgslcblas -lgsl"

            CPPFLAGS="${GSL_CPPFLAGS} ${CPPFLAGS}"
            LDFLAGS="${GSL_LDFLAGS} ${LDFLAGS}"
            LIBS="$GSL_LIBS"
        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_GSLDIR})
        fi
    fi

    AC_CHECK_HEADERS(math.h gsl/gsl_cblas.h gsl/gsl_blas.h,
                    AC_CHECK_LIB(m,
                                 cos,,
                                 [AC_MSG_ERROR(cannot find function cos)]
                                )
                    AC_CHECK_LIB(gslcblas,
                                 cblas_dgemm,,
                                 [AC_MSG_ERROR(cannot find function cblas_dgemm)]
                                )
                    AC_CHECK_LIB(gsl,
                                 gsl_blas_dgemm,,
                                 [AC_MSG_ERROR(cannot find function gsl_blas_dgemm)]
                                ),
                    [AC_MSG_ERROR(cannot find gsl header files)]
                   )
    RACK_SUPPORTS="gsl ${RACK_SUPPORTS}"

    AC_SUBST(GSL_CPPFLAGS)
    AC_SUBST(GSL_LDFLAGS)
    AC_SUBST(GSL_LIBS)

    CPPFLAGS="${cppflags_backup}"
    LDFLAGS="${ldflags_backup}"
    LIBS="${libs_backup}"
fi

AM_CONDITIONAL(CONFIG_GSL,
               [test x"${GSL_LIBS}" != x""])

AM_CONDITIONAL(CONFIG_RACK_GSL_SUPPORT,
               [test x"${CONFIG_RACK_GSL_SUPPORT}" = "xy"])

dnl ----- libusb --------------------------------------------------------------
dnl
dnl  depends on nothing
dnl  provides headers: yes
dnl  provides libs:    yes
dnl

AC_MSG_CHECKING([libusb support])
AC_MSG_RESULT([${CONFIG_RACK_LIBUSB_SUPPORT}])

LIBUSB_CPPFLAGS=""
LIBUSB_LDFLAGS=""
LIBUSB_LIBS=""

if test x"${CONFIG_RACK_LIBUSB_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_LIBUSBDIR" \!= "xy"; then
        CONFIG_RACK_LIBUSBDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/libusb"
    fi

    cppflags_backup="${CPPFLAGS}"
    ldflags_backup="${LDFLAGS}"
    libs_backup="${LIBS}"

    if test x${CONFIG_RACK_LIBUSBDIR} != "x"; then
        AC_MSG_CHECKING([libusb directory])
        if test -d ${CONFIG_RACK_LIBUSBDIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_LIBUSBDIR}])

            LIBUSB_CPPFLAGS="-I${CONFIG_RACK_LIBUSBDIR}/include/libusb-1.0"
            LIBUSB_LDFLAGS="-L${CONFIG_RACK_LIBUSBDIR}/lib -Wl,-rpath=${CONFIG_RACK_LIBUSBDIR}/lib"
            LIBUSB_LIBS="-lusb-1.0"

            CPPFLAGS="${LIBUSB_CPPFLAGS} ${CPPFLAGS}"
            LDFLAGS="${LIBUSB_LDFLAGS} ${LDFLAGS}"
            LIBS="$LIBUSB_LIBS"
        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_LIBUSBDIR})
        fi
    fi

    AC_CHECK_HEADER(libusb.h,
                    AC_CHECK_LIB(usb-1.0,
                                 libusb_get_device_list,,
                                 [AC_MSG_ERROR(cannot find function libusb_get_device_list)]
                                ),
                    [AC_MSG_ERROR(cannot find libusb header files)]
                   )

    RACK_SUPPORTS="libusb ${RACK_SUPPORTS}"
    CPPFLAGS="${cppflags_backup}"
    LDFLAGS="${ldflags_backup}"
    LIBS="${libs_backup}"
fi

AC_SUBST(LIBUSB_CPPFLAGS)
AC_SUBST(LIBUSB_LDFLAGS)
AC_SUBST(LIBUSB_LIBS)
AM_CONDITIONAL(CONFIG_RACK_LIBUSB_SUPPORT,
               [test x"${CONFIG_RACK_LIBUSB_SUPPORT}" = "xy"])

dnl ----- boost --------------------------------------------------------------
dnl
dnl  depends on nothing
dnl  provides headers: yes
dnl  provides libs:    yes
dnl

AC_MSG_CHECKING([boost support])
AC_MSG_RESULT([${CONFIG_RACK_BOOST_SUPPORT}])

BOOST_CPPFLAGS=""
BOOST_LDFLAGS=""
BOOST_LIBS=""

if test x"${CONFIG_RACK_BOOST_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_BOOSTDIR" \!= "xy"; then
        CONFIG_RACK_BOOSTDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/boost"
    fi

    if test x${CONFIG_RACK_BOOSTDIR} != "x"; then
        AC_MSG_CHECKING([boost directory])
        if test -d ${CONFIG_RACK_BOOSTDIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_BOOSTDIR}])

            BOOST_ROOT="${CONFIG_RACK_BOOSTDIR}"
            BOOST_REQUIRE(1.40.0)

            BOOST_DATE_TIME()
            BOOST_FILESYSTEM()
            BOOST_PROGRAM_OPTIONS()
            BOOST_REGEX()
            BOOST_SERIALIZATION()
            BOOST_SIGNALS()
            BOOST_SYSTEM()
            BOOST_TEST()
            BOOST_THREADS()
            BOOST_WAVE()

            BOOST_LDFLAGS="${BOOST_DATE_TIME_LDFLAGS}"
            BOOST_LIBS="${BOOST_DATE_TIME_LIBS} ${BOOST_FILESYSTEM_LIBS} ${BOOST_PROGRAM_OPTIONS_LIBS} ${BOOST_REGEX_LIBS} ${BOOST_SERIALIZATION_LIBS} ${BOOST_SIGNALS_LIBS} ${BOOST_SYSTEM_LIBS} ${BOOST_THREAD_LIBS} ${BOOST_WAVE_LIBS}"

        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_BOOSTDIR})
        fi
    fi

    RACK_SUPPORTS="boost ${RACK_SUPPORTS}"
fi

AC_SUBST(BOOST_CPPFLAGS)
AC_SUBST(BOOST_LDFLAGS)
AC_SUBST(BOOST_LIBS)
AM_CONDITIONAL(CONFIG_RACK_BOOST_SUPPORT,
               [test x"${CONFIG_RACK_BOOST_SUPPORT}" = "xy"])

dnl ----- pcl ----------------------------------------------------
dnl
dnl  depends on flann, eigen, boost
dnl  provides headers: yes
dnl  provides libs:    yes
dnl

AC_MSG_CHECKING([pcl support])
AC_MSG_RESULT([${CONFIG_RACK_PCL_SUPPORT}])
AC_LANG_PUSH([C++])

PCL_CPPFLAGS=""
PCL_LDFLAGS=""
PCL_LIBS=""

if test x"${CONFIG_RACK_PCL_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_PCLDIR" \!= "xy"; then
        CONFIG_RACK_PCLDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/pcl"
    fi

    cppflags_backup="${CPPFLAGS}"
    ldflags_backup="${LDFLAGS}"
    libs_backup="${LIBS}"

    if test x${CONFIG_RACK_PCLDIR} != "x"; then
        AC_MSG_CHECKING([pcl directory])
        if test -d ${CONFIG_RACK_PCLDIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_PCLDIR}])

            EIGEN_CPPFLAGS="-I${CONFIG_RACK_LIRE_INSTALLDIR}/eigen/include/eigen3"
            EIGEN_LDFLAGS=""
            EIGEN_LIBS=""

            FLANN_CPPFLAGS="-I${CONFIG_RACK_LIRE_INSTALLDIR}/flann/include"
            FLANN_LDFLAGS="-L${CONFIG_RACK_LIRE_INSTALLDIR}/flann/lib"
            FLANN_LIBS="-lflann -lflann_cpp -lflann_cpp-gd"

            PCL_CPPFLAGS="${FLANN_CPPFLAGS} ${BOOST_CPPFLAGS} ${EIGEN_CPPFLAGS} -I${CONFIG_RACK_PCLDIR}/include/pcl-1.6"
            PCL_LDFLAGS="${BOOST_LDFLAGS} -L${CONFIG_RACK_PCLDIR}/lib -Wl,-rpath=${CONFIG_RACK_PCLDIR}/lib"
            PCL_LIBS="-lpcl_features -lpcl_filters -lpcl_io -lpcl_keypoints -lpcl_registration -lpcl_sample_consensus -lpcl_segmentation"

            CPPFLAGS="${PCL_CPPFLAGS} ${CPPFLAGS}"
            LDFLAGS="${PCL_LDFLAGS} ${LDFLAGS}"
            LIBS="${PCL_LIBS}"
        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_PCLDIR})
        fi
    fi

    AC_CHECK_HEADER([pcl/point_cloud.h],
                    AC_CHECK_LIB(pcl_filters,
                                 main,,
                                 [AC_MSG_ERROR(cannot find pcl_filters library)]
                                ),
                    [AC_MSG_ERROR(cannot find pcl header files)]
                   )
    AC_CHECK_HEADER([pcl/kdtree/kdtree_flann.h],
                    AC_CHECK_LIB(pcl_kdtree,
                                 main,,
                                 [AC_MSG_ERROR(cannot find pcl_kdtree library)]
                                ),
                    [AC_MSG_ERROR(cannot find pcl header files)]
                   )

    RACK_SUPPORTS="pcl ${RACK_SUPPORTS}"
    CPPFLAGS="${cppflags_backup}"
    LDFLAGS="${ldflags_backup}"
    LIBS="${libs_backup}"
fi

AC_LANG_POP([C++])
AC_SUBST(PCL_CPPFLAGS)
AC_SUBST(PCL_LDFLAGS)
AC_SUBST(PCL_LIBS)

AM_CONDITIONAL(CONFIG_PCL,
               [test x"${PCL_LIBS}" != x""])

AM_CONDITIONAL(CONFIG_RACK_PCL_SUPPORT,
               [test x"${CONFIG_RACK_PCL_SUPPORT}" = "xy"])

dnl ----- openni ----------------------------------------------------
dnl
dnl  depends on libusb
dnl  provides headers: yes
dnl  provides libs:    yes
dnl

AC_MSG_CHECKING([openni support])
AC_MSG_RESULT([${CONFIG_RACK_OPENNI_SUPPORT}])

OPENNI_CPPFLAGS=""
OPENNI_LDFLAGS=""
OPENNI_LIBS=""

if test x"${CONFIG_RACK_OPENNI_SUPPORT}" = x"y"; then

    if test x"$CONFIG_RACK_EXT_OPENNIDIR" \!= "xy"; then
        CONFIG_RACK_OPENNIDIR="${CONFIG_RACK_LIRE_INSTALLDIR}/openni/usr"
    fi

    cppflags_backup="${CPPFLAGS}"
    ldflags_backup="${LDFLAGS}"
    libs_backup="${LIBS}"

    if test x${CONFIG_RACK_OPENNIDIR} != "x"; then
        AC_MSG_CHECKING([openni directory])
        if test -d ${CONFIG_RACK_OPENNIDIR}; then
            AC_MSG_RESULT([${CONFIG_RACK_OPENNIDIR}])

            OPENNI_CPPFLAGS="${LIBUSB_CPPFLAGS} -I${CONFIG_RACK_OPENNIDIR}/include/ni"
            OPENNI_LDFLAGS="${LIBUSB_LDFLAGS} -L${CONFIG_RACK_OPENNIDIR}/lib -Wl,-rpath=${CONFIG_RACK_OPENNIDIR}/lib"
            OPENNI_LIBS="${LIBUSB_LIBS} -lOpenNI -lnimCodecs -lnimMockNodes -lnimRecorder"

            CPPFLAGS="${OPENNI_CPPFLAGS} ${CPPFLAGS}"
            LDFLAGS="${OPENNI_LDFLAGS} ${LDFLAGS}"
            LIBS="${OPENNI_LIBS}"
        else
            AC_MSG_ERROR(cannot find ${CONFIG_RACK_OPENNIDIR})
        fi
    fi

    AC_CHECK_HEADER([XnOS.h],
                    AC_CHECK_LIB(OpenNI,
                                 xnOSInit,,
                                 [AC_MSG_ERROR(cannot find OpenNI library)]
                                ),
                    [AC_MSG_ERROR(cannot find openni header files)]
                   )

    RACK_SUPPORTS="openni ${RACK_SUPPORTS}"
    CPPFLAGS="${cppflags_backup}"
    LDFLAGS="${ldflags_backup}"
    LIBS="${libs_backup}"
fi

AC_SUBST(OPENNI_CPPFLAGS)
AC_SUBST(OPENNI_LDFLAGS)
AC_SUBST(OPENNI_LIBS)

AM_CONDITIONAL(CONFIG_OPENNI,
               [test x"${OPENNI_LIBS}" != x""])

AM_CONDITIONAL(CONFIG_RACK_OPENNI_SUPPORT,
               [test x"${CONFIG_RACK_OPENNI_SUPPORT}" = "xy"])

dnl ======================================================================
dnl  set flags / libs
dnl ======================================================================

RACK_GLOBAL_CPPFLAGS="-Wall -pipe -O2 -fstrict-aliasing"
RACK_GLOBAL_LDFLAGS=""

AC_SUBST(RACK_GLOBAL_CPPFLAGS)
AC_SUBST(RACK_GLOBAL_LDFLAGS)

if test x"${CONFIG_RACK_OS_XENOMAI}" = x"y"; then

RACK_CPPFLAGS="-D__IN_RACK__ -I\${top_srcdir} -I\${top_builddir} ${XENOMAI_CPPFLAGS} ${RACK_GLOBAL_CPPFLAGS}"
RACK_LDFLAGS="-L\$(top_builddir)/main/lib/.libs ${XENOMAI_LDFLAGS} ${RACK_GLOBAL_LDFLAGS}"
RACK_LIBS="-l${PROJNAME} ${XENOMAI_LIBS}"

else

RACK_CPPFLAGS="-D__IN_RACK__ -I\${top_srcdir} -I\${top_builddir} ${LINUX_CPPFLAGS} ${RACK_GLOBAL_CPPFLAGS}"
RACK_LDFLAGS="-L\$(top_builddir)/main/lib/.libs ${LINUX_LDFLAGS} ${RACK_GLOBAL_LDFLAGS}"
RACK_LIBS="-l${PROJNAME} ${LINUX_LIBS}"

fi

if test x"${CONFIG_RACK_PROXIES_MSG_SIZE_SCANDRIVE}" = x"y"; then
RACK_MSG_SIZE_CPPFLAGS="-D__MSG_SCANDRIVE__"
fi

if test x"${CONFIG_RACK_PROXIES_MSG_SIZE_VELODYNE}" = x"y"; then
RACK_MSG_SIZE_CPPFLAGS="-D__MSG_VELODYNE__"
fi

if test x"${CONFIG_RACK_PROXIES_MSG_SIZE_KINECT}" = x"y"; then
RACK_MSG_SIZE_CPPFLAGS="-D__MSG_KINECT__"
fi

RACK_CPPFLAGS="${RACK_MSG_SIZE_CPPFLAGS} ${RACK_CPPFLAGS}"

AC_SUBST(RACK_MSG_SIZE_CPPFLAGS)
AC_SUBST(RACK_CPPFLAGS)
AC_SUBST(RACK_LDFLAGS)
AC_SUBST(RACK_LIBS)


dnl ======================================================================
dnl  current project
dnl ======================================================================

RACK_SUPPORTS="${PROJNAME} ${RACK_SUPPORTS}"
AC_SUBST(RACK_SUPPORTS)


dnl ======================================================================
dnl             doxygen documentation
dnl ======================================================================

if test \! -d $srcdir/doc; then
    unset RACK_MAYBE_DOCDIR
else
    RACK_MAYBE_DOCDIR=doc
fi
AC_SUBST(RACK_MAYBE_DOCDIR)

AC_MSG_CHECKING(for Doxygen documentation)
AC_ARG_ENABLE(dox-doc,
    AS_HELP_STRING([--enable-dox-doc], [Build Doxygen documentation]),
    [case "$enableval" in
    y | yes) CONFIG_RACK_DOC_DOX=y ;;
    *) unset CONFIG_RACK_DOC_DOX ;;
    esac])

if test \! -d $srcdir/doc; then
    if test x$CONFIG_RACK_DOC_DOX = xy ;
    then
        AC_MSG_ERROR([documentation tree is missing.])
    fi
    AC_MSG_RESULT([not present])
else
    AC_MSG_RESULT(${CONFIG_RACK_DOC_DOX:-no})
fi

AC_CHECK_PROG(DOXYGEN, doxygen, doxygen)

if test x${CONFIG_RACK_DOC_DOX} = xy -a x"$DOXYGEN" = x; then
   AC_MSG_ERROR([Missing the Doxygen tools to generate the documentation.])
fi

AC_CHECK_PROG(DOXYGEN_HAVE_DOT, dot, YES, NO)
if test x"$DOXYGEN_HAVE_DOT" = xYES; then
   DOXYGEN_SHOW_INCLUDE_FILES=NO
else
   DOXYGEN_SHOW_INCLUDE_FILES=YES
fi

AM_CONDITIONAL(CONFIG_RACK_DOC_DOX,[test "$CONFIG_RACK_DOC_DOX" = y])
AC_SUBST(DOXYGEN_SHOW_INCLUDE_FILES)
AC_SUBST(DOXYGEN_HAVE_DOT)
AC_SUBST(DOXYGEN)

dnl ======================================================================
dnl             crosscompiling
dnl ======================================================================

AC_MSG_CHECKING([for CROSS_COMPILE])
if test "${CROSS_COMPILE}" = ""; then
    CROSS_COMPILE="`echo ${CC} | sed s/gcc//`"

    if test "${CROSS_COMPILE}gcc" \!= "${CC}"; then
        CROSS_COMPILE=""
        AC_MSG_RESULT([Cannot identify CROSS_COMPILE - assuming none - set manually if needed])
    else
        if test "${CROSS_COMPILE}" = ""; then
            AC_MSG_RESULT([none])
        else
            AC_MSG_RESULT([${CROSS_COMPILE}])
        fi
    fi
else
    AC_MSG_RESULT([${CROSS_COMPILE}])
fi
AC_SUBST(CROSS_COMPILE)

dnl ======================================================================
dnl             build for 2.6 kernel
dnl ======================================================================

RACK_MODULE_EXT=.ko
RACK_KBUILD_ENV='src2obj = $(patsubst %.$(1),%.o,$(filter %.$(1),$(call notdir,$(2))))'
RACK_KBUILD_CMD="                                                           \
        @for src in \$(filter-out FORCE, \$^); do                           \
            if test \\! -r \`basename \$\$src\`; then                       \
                \$(LN_S) \$\$src;                                           \
            fi;                                                             \
        done;                                                               \
        \$(MAKE) -C ${CONFIG_RACK_LINUXDIR}                                 \
                CROSS_COMPILE=\$(CROSS_COMPILE)                             \
                ARCH=\$(RACK_TARGET_ARCH)                                   \
                M=\"\`pwd\`\"                                               \
                V=\$(V)                                                     \
                rack_kmod_cflags=\"\$(RACK_KMOD_CFLAGS)\"                   \
                top_srcdir=\"\`cd \$(top_srcdir) && pwd\`\"                 \
                top_builddir=\"\`cd \$(top_builddir) && pwd\`\"             \
                linux-dir=\"${CONFIG_RACK_LINUXDIR}\"                       \
                xeno_user_dir=\"${XENO_USER_PREFIX}\"                       \
                srcdir=\"\`cd \$(srcdir) && pwd\`\"                         \
                build_objs='\$(call src2obj,c,\$^)'                         \
                build_target='\$(basename \$@)'                             \
                modules                                                     \
                "

RACK_KBUILD_CLEAN="                                                         \
        @rm -rf *.ko *.mod.c .*.cmd *.o .tmp_versions Module*.symvers;      \
        for src in \$^; do                                                  \
            if test -h \`basename \$\$src\`; then                           \
                rm -f \`basename \$\$src\`;                                 \
            fi;                                                             \
        done;                                                               \
        "
RACK_KBUILD_DISTCLEAN="                                                     \
        @for mod in \${OBJS}; do                                            \
            rm -f \`cd \$(top_builddir) && pwd\`/symbols/\`echo \$\$mod |   \
                sed -e's/${RACK_MODULE_EXT}//'\`.mod;                       \
        done;                                                               \
        "

AC_MSG_CHECKING([for kernel module extension])
AC_MSG_RESULT([$RACK_MODULE_EXT])

AC_SUBST(RACK_MODULE_EXT)
AC_SUBST(RACK_KBUILD_ENV)
AC_SUBST(RACK_KBUILD_CMD)
AC_SUBST(RACK_KBUILD_CLEAN)
AC_SUBST(RACK_KBUILD_DISTCLEAN)

bs_kmodext=$RACK_MODULE_EXT
bs_kcompile="make -C $CONFIG_RACK_LINUXDIR ARCH=$RACK_TARGET_ARCH CROSS_COMPILE=$CROSS_COMPILE V=1 M=`pwd` SUBDIRS=`pwd` modules"

dnl ======================================================================
dnl             Installation directory for modules
dnl ======================================================================

AC_MSG_CHECKING([for module installation directory])

AC_ARG_WITH(module-dir,
    AS_HELP_STRING([--with-module-dir=<module-dir>], [Installation directory for modules]),
    [case "${withval}" in
    "" | y | ye | yes | n | no)
        AC_MSG_ERROR([You must supply an argument to --with-module-dir.]) ;;
    esac],
    with_module_dir='${exec_prefix}/lib/rack')
RACK_MODULE_DIR="$with_module_dir"
AC_MSG_RESULT([$RACK_MODULE_DIR])

AC_SUBST(RACK_MODULE_DIR)

dnl ======================================================================
dnl             hac^H^H^Hfix problem with multible defined symbols problem
dnl             shamelessly stolen from RTAI-3.1 tnx to Philippe
dnl ======================================================================

dnl CAUTION: We need to have the CONFIG_RACK_XX symbols always defined when
dnl the configuration header is read, but we want the Autoconf-produced
dnl symbols to be defined only when compiling RACK. This way, we won't
dnl pollute the namespace with the latter when our configuration header is
dnl indirectly included by a client application. To achieve this, we ask
dnl autoheader to produce the following header structure:
dnl #define CONFIG_XX
dnl #define CONFIG_XX ...
dnl #ifdef __IN_RACK__
dnl <Autoconf-defined symbols>
dnl #endif /* __IN_RACK__ */
dnl This is quite a hack since we have to rely on the fact that
dnl all Autoconf-generated symbols are lexicographically sorted
dnl after CONFIG_RACK_XX ones, but, well...

dnl Use a key which will cause the verbatim string to be put after
dnl all CONFIG_RACK_XX symbols, but still before any Autoconf-generated
dnl symbol, hence CONFIG_RACK___.
AH_VERBATIM(CONFIG_RACK___,[#ifdef __IN_RACK__])

dnl Now we can close the conditional section, right after all
dnl Autoconf-generated symbols have been listed.
AH_BOTTOM([#endif /* __IN_RACK__ */])

RACK_KMOD_CFLAGS="-D__IN_RACK__ $RACK_KMOD_CFLAGS"

AC_SUBST(RACK_KMOD_CFLAGS)

dnl ======================================================================
dnl             create links to Makefiles used by linux-2.6.x
dnl ======================================================================

for DIR in \
    main/tims/xenomai_kmod \
    ; do
      AC_CONFIG_LINKS(${DIR}/Makefile:${DIR}/Makefile.kbuild)
done

dnl ======================================================================
dnl             generate output
dnl ======================================================================

AC_CONFIG_FILES([GNUmakefile \
    \
    config/GNUmakefile \
    config/kconfig/GNUmakefile \
    config/kconfig/lxdialog/GNUmakefile \
    \
    main/GNUmakefile \
    main/defines/GNUmakefile \
    main/lib/GNUmakefile \
    main/tools/GNUmakefile \
    main/common/GNUmakefile \
    main/xenomai/GNUmakefile \
    main/linux/GNUmakefile \
    main/tims/GNUmakefile \
    main/tims/xenomai/GNUmakefile \
    main/tims/xenomai_kmod/GNUmakefile \
    main/tims/linux/GNUmakefile \
    main/tims/router/GNUmakefile \
    \
    control/GNUmakefile \
    \
    drivers/GNUmakefile \
    drivers/camera/GNUmakefile \
    drivers/chassis/GNUmakefile \
    drivers/clock/GNUmakefile \
    drivers/compass/GNUmakefile \
    drivers/gps/GNUmakefile \
    drivers/gyro/GNUmakefile \
    drivers/ladar/GNUmakefile \
    \
    navigation/GNUmakefile \
    navigation/odometry/GNUmakefile \
    navigation/pilot/GNUmakefile \
    navigation/position/GNUmakefile \
    \
    perception/GNUmakefile \
    perception/scan2d/GNUmakefile \
    perception/obj_recog/GNUmakefile \
    \
    skel/GNUmakefile \
    skel/dummy/GNUmakefile \
    \
    gui/GNUmakefile \
    gui/main/GNUmakefile \
    gui/control/GNUmakefile \
    gui/drivers/GNUmakefile \
    gui/navigation/GNUmakefile \
    gui/perception/GNUmakefile \
    gui/tools/GNUmakefile \
    \
    tools/GNUmakefile \
    tools/datalog/GNUmakefile \
    \
    examples/GNUmakefile \
    examples/linux_example \
    examples/xenomai_example \
    examples/load_tims_linux \
    examples/load_tims_xenomai \
    examples/load_rack_sim \
    examples/unload_tims_linux \
    examples/unload_tims_xenomai \
    examples/unload_rack_sim \
    examples/rack_gui \
    \
    scripts/GNUmakefile \
    scripts/]ConfigScript[ \
    \
])

if test \! x$RACK_MAYBE_DOCDIR = x; then

AC_CONFIG_FILES([ \
    doc/GNUmakefile \
    doc/doxygen/GNUmakefile \
    doc/doxygen/Doxyfile \
])

fi

if test x"$CONFIG_RACK_JAVA" = x"y"; then
AC_CONFIG_COMMANDS([java-link], [if test ! -e ProjectName; then $LN_S . ProjectName; fi], [LN_S="$LN_S"])
else
AC_CONFIG_COMMANDS([java-unlink], [if test -e ProjectName; then rm -rf ProjectName; fi])
fi

AC_OUTPUT

dnl ======================================================================
dnl generate ${PROJNAME}_config.h
dnl ======================================================================

AC_MSG_NOTICE([creating ]ProjectName[_config.h])
sed -e "s/ PACKAGE/ RACK_PACKAGE/" -e "s/ VERSION/ RACK_VERSION/" \
    config/${PROJNAME}_config_pre.h > ${PROJNAME}_config.h.new
if cmp -s ${PROJNAME}_config.h.new ${PROJNAME}_config.h; then
    rm ${PROJNAME}_config.h.new
    AC_MSG_NOTICE(ProjectName[_config.h is unchanged])
else
    mv ${PROJNAME}_config.h.new ${PROJNAME}_config.h
fi
